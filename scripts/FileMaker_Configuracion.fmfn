#####################################################################
# SCRIPT FILEMAKER: ConfiguraciÃ³n Inicial
# DescripciÃ³n: Configurar conexiÃ³n y probar endpoint de QR
# VersiÃ³n: 1.0
#####################################################################

# ===============================
# CONFIGURACIÃ“N DE VARIABLES
# ===============================

# Mostrar diÃ¡logo de configuraciÃ³n
Show Custom Dialog [ "ConfiguraciÃ³n API - FacturaciÃ³n ElectrÃ³nica" ; 
    "Configure la conexiÃ³n al servidor de facturaciÃ³n electrÃ³nicaÂ¶Â¶" &
    "ğŸ“‹ InformaciÃ³n requerida:Â¶" &
    "â€¢ URL del servidor (https://...)Â¶" &
    "â€¢ Token de autenticaciÃ³n BearerÂ¶Â¶" &
    "âš ï¸ AsegÃºrese de tener los datos correctos" ; 
    "Configurar" ; "Cancelar" 
]

If [ Get ( LastMessageChoice ) = 2 ]
    Exit Script [ Text Result: "ConfiguraciÃ³n cancelada" ]
End If

# ===============================
# SOLICITAR DATOS DE CONEXIÃ“N
# ===============================

# Solicitar URL del servidor
Show Custom Dialog [ "URL del Servidor" ; 
    "Ingrese la URL completa del servidor:Â¶Â¶" &
    "Ejemplo: https://api.labcontreras.comÂ¶" &
    "âš ï¸ Debe empezar con https://" ; 
    "URL:" ; "https://" 
]

If [ Get ( LastMessageChoice ) = 2 ]
    Exit Script [ Text Result: "ConfiguraciÃ³n cancelada" ]
End If

Set Variable [ $servidor ; Value: Get ( ScriptParameter ) ]

# Validar URL
If [ Left ( $servidor ; 8 ) â‰  "https://" ]
    Show Custom Dialog [ "URL InvÃ¡lida" ; 
        "âŒ La URL debe empezar con https://Â¶Â¶" &
        "Ejemplo correcto: https://api.labcontreras.com"
    ]
    Exit Script [ Text Result: "Error: URL invÃ¡lida" ]
End If

# Solicitar token
Show Custom Dialog [ "Token de AutenticaciÃ³n" ; 
    "Ingrese su token Bearer:Â¶Â¶" &
    "ğŸ’¡ Este token lo proporciona el administradorÂ¶" &
    "âš ï¸ MantÃ©ngalo seguro" ; 
    "Token:" ; "" 
]

If [ Get ( LastMessageChoice ) = 2 ]
    Exit Script [ Text Result: "ConfiguraciÃ³n cancelada" ]
End If

Set Variable [ $token ; Value: Get ( ScriptResult ) ]

# Validar token
If [ IsEmpty ( $token ) or Length ( $token ) < 20 ]
    Show Custom Dialog [ "Token InvÃ¡lido" ; 
        "âŒ El token parece ser invÃ¡lidoÂ¶Â¶" &
        "â€¢ No puede estar vacÃ­oÂ¶" &
        "â€¢ Debe tener al menos 20 caracteres"
    ]
    Exit Script [ Text Result: "Error: Token invÃ¡lido" ]
End If

# ===============================
# PROBAR CONEXIÃ“N
# ===============================

Show Custom Dialog [ "Probando ConexiÃ³n" ; 
    "ğŸ”„ Probando conexiÃ³n al servidor...Â¶Â¶" &
    "Servidor: " & $servidor & "Â¶" &
    "Token: " & Left ( $token ; 10 ) & "..." ; 
    "Continuar" 
]

# Preparar peticiÃ³n de prueba
Set Variable [ $headers ; Value: "Authorization: Bearer " & $token ]

# Intentar conexiÃ³n con endpoint de test
Insert from URL [ 
    Target: $resultado_prueba ;
    URL: $servidor & "/comprobantes/test-auth" ;
    Headers: $headers ;
    Verify SSL Certificates: Off
]

# Procesar resultado de la prueba
Set Variable [ $status_prueba ; Value: JSONGetElement ( $resultado_prueba ; "status" ) ]

If [ $status_prueba = "success" ]
    # ===========================
    # CONEXIÃ“N EXITOSA
    # ===========================
    
    # Guardar configuraciÃ³n
    Set Field [ Configuracion::ServidorAPI ; $servidor ]
    Set Field [ Configuracion::TokenAPI ; $token ]
    Set Field [ Configuracion::FechaConfiguracion ; Get ( CurrentTimeStamp ) ]
    Set Field [ Configuracion::EstadoConexion ; "Conectado" ]
    Set Field [ Configuracion::UltimaPrueba ; Get ( CurrentTimeStamp ) ]
    
    # Confirmar Ã©xito
    Show Custom Dialog [ "ConfiguraciÃ³n Exitosa" ; 
        "âœ… Â¡ConexiÃ³n establecida correctamente!Â¶Â¶" &
        "ğŸ“‹ CONFIGURACIÃ“N GUARDADA:Â¶" &
        "â€¢ Servidor: " & $servidor & "Â¶" &
        "â€¢ Estado: ConectadoÂ¶" &
        "â€¢ Fecha: " & Get ( CurrentTimeStamp ) & "Â¶Â¶" &
        "ğŸ‰ Ya puede usar la facturaciÃ³n electrÃ³nica"
    ]
    
    # ===========================
    # PROBAR ENDPOINT DE QR
    # ===========================
    
    Show Custom Dialog [ "Â¿Probar generaciÃ³n de QR?" ; 
        "âœ… ConexiÃ³n bÃ¡sica exitosaÂ¶Â¶" &
        "Â¿Desea probar la generaciÃ³n de cÃ³digos QR?Â¶" &
        "(Se crearÃ¡ un QR de prueba)" ; 
        "Probar QR" ; "DespuÃ©s" 
    ]
    
    If [ Get ( LastMessageChoice ) = 1 ]
        # Probar endpoint de QR con URL de ejemplo
        Set Variable [ $url_prueba ; Value: "https://dgii.gov.do/ecf/consulta/?rnc=130085765&ncf=E310000000001&codigo=TEST123&fecha=01-01-2025" ]
        
        Set Variable [ $body_qr_prueba ; Value: JSONSetElement ( "{}" ; 
            [ "url" ; $url_prueba ; JSONString ] ;
            [ "formato" ; "png" ; JSONString ] ;
            [ "tamaÃ±o" ; 200 ; JSONNumber ]
        ) ]
        
        Set Variable [ $headers_qr ; Value: "Authorization: Bearer " & $token & Â¶ & "Content-Type: application/json" ]
        
        Insert from URL [ 
            Target: $resultado_qr_prueba ;
            URL: $servidor & "/comprobantes/generar-qr" ;
            Request Data: $body_qr_prueba ;
            Headers: $headers_qr ;
            Verify SSL Certificates: Off
        ]
        
        Set Variable [ $status_qr_prueba ; Value: JSONGetElement ( $resultado_qr_prueba ; "status" ) ]
        
        If [ $status_qr_prueba = "success" ]
            Set Variable [ $version_qr ; Value: JSONGetElement ( $resultado_qr_prueba ; "data.version" ) ]
            Set Variable [ $cumple_dgii ; Value: JSONGetElement ( $resultado_qr_prueba ; "data.especificaciones.cumpleNormativaDGII" ) ]
            
            Show Custom Dialog [ "Prueba de QR Exitosa" ; 
                "ğŸ‰ Â¡GeneraciÃ³n de QR funcional!Â¶Â¶" &
                "ğŸ“± DETALLES DEL QR:Â¶" &
                "â€¢ VersiÃ³n: " & $version_qr & " (DGII)Â¶" &
                "â€¢ Cumple normativa: " & If ( $cumple_dgii = True ; "âœ… SÃ­" ; "âŒ No" ) & "Â¶" &
                "â€¢ Formato: PNGÂ¶" &
                "â€¢ TamaÃ±o: 200pxÂ¶Â¶" &
                "âœ… Sistema completamente funcional"
            ]
            
            Set Field [ Configuracion::QRFuncional ; True ]
            Set Field [ Configuracion::VersionQR ; $version_qr ]
        Else
            Set Variable [ $error_qr_prueba ; Value: JSONGetElement ( $resultado_qr_prueba ; "message" ) ]
            
            Show Custom Dialog [ "Error en Prueba de QR" ; 
                "âš ï¸ ConexiÃ³n OK, pero error en QRÂ¶Â¶" &
                "Error: " & $error_qr_prueba & "Â¶Â¶" &
                "ğŸ’¡ La facturaciÃ³n funciona, peroÂ¶" &
                "revise la configuraciÃ³n del endpoint QR"
            ]
            
            Set Field [ Configuracion::QRFuncional ; False ]
            Set Field [ Configuracion::ErrorQR ; $error_qr_prueba ]
        End If
    End If
    
Else
    # ===========================
    # ERROR DE CONEXIÃ“N
    # ===========================
    Set Variable [ $error_conexion ; Value: JSONGetElement ( $resultado_prueba ; "message" ) ]
    
    Show Custom Dialog [ "Error de ConexiÃ³n" ; 
        "âŒ No se pudo establecer conexiÃ³nÂ¶Â¶" &
        "Error: " & If ( IsEmpty ( $error_conexion ) ; "Servidor no disponible" ; $error_conexion ) & "Â¶Â¶" &
        "ğŸ”§ POSIBLES SOLUCIONES:Â¶" &
        "â€¢ Verificar URL del servidorÂ¶" &
        "â€¢ Comprobar token de autenticaciÃ³nÂ¶" &
        "â€¢ Revisar conexiÃ³n a internetÂ¶" &
        "â€¢ Contactar administrador del sistema"
    ]
    
    # Guardar intento fallido para anÃ¡lisis
    Set Field [ Configuracion::ServidorAPI ; $servidor ]
    Set Field [ Configuracion::TokenAPI ; "[ERROR]" ]
    Set Field [ Configuracion::EstadoConexion ; "Error" ]
    Set Field [ Configuracion::ErrorConexion ; $error_conexion ]
    Set Field [ Configuracion::FechaError ; Get ( CurrentTimeStamp ) ]
End If

# ===============================
# LIMPIEZA DE SEGURIDAD
# ===============================
# Limpiar variables con informaciÃ³n sensible
Set Variable [ $token ; Value: "" ]
Set Variable [ $headers ; Value: "" ]
Set Variable [ $headers_qr ; Value: "" ]

#####################################################################
# FIN DEL SCRIPT DE CONFIGURACIÃ“N
#####################################################################