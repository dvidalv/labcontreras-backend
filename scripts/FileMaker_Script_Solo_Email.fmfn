#####################################################################
# SCRIPT FILEMAKER: EnvÃ­o de Email Independiente
# DescripciÃ³n: EnvÃ­a email de documento electrÃ³nico ya procesado
# Endpoint: /comprobantes/enviar-email
# VersiÃ³n: 1.0
#####################################################################

# ===============================
# CONFIGURACIÃ“N INICIAL
# ===============================
Set Variable [ $servidor ; Value: "https://tu-servidor.com" ]
Set Variable [ $token ; Value: "tu_token_bearer_aqui" ]

# ===============================
# VALIDACIONES PREVIAS
# ===============================
# Verificar que la factura estÃ© procesada
If [ IsEmpty ( Facturas::NCF ) or IsEmpty ( Facturas::EstadoEnvio ) or Facturas::EstadoEnvio â‰  "Enviado Exitosamente" ]
    Show Custom Dialog [ "Factura No Procesada" ; "âŒ Esta factura no estÃ¡ procesada electrÃ³nicamenteÂ¶Â¶Primero debe:Â¶â€¢ Enviar la factura a DGIIÂ¶â€¢ Esperar confirmaciÃ³n exitosaÂ¶Â¶Luego podrÃ¡ enviar el email" ]
    Exit Script [ Text Result: "Error: Factura no procesada" ]
End If

# Verificar email del comprador
If [ IsEmpty ( Facturas::CompradorCorreo ) or PatternCount ( Facturas::CompradorCorreo ; "@" ) = 0 ]
    Show Custom Dialog [ "Email Requerido" ; "âŒ No hay email vÃ¡lido del compradorÂ¶Â¶Email actual: " & Facturas::CompradorCorreo & "Â¶Â¶Por favor ingrese un email vÃ¡lido." ; "Ingresar Email" ; "Cancelar" ]
    
    If [ Get ( LastMessageChoice ) = 1 ]
        # Permitir ingresar email
        Show Custom Dialog [ "Ingresar Email" ; "ğŸ“§ Email del comprador:" ; Facturas::CompradorCorreo ]
        Set Field [ Facturas::CompradorCorreo ; Get ( LastMessageChoice ) ]
        
        # Verificar nuevo email
        If [ IsEmpty ( Facturas::CompradorCorreo ) or PatternCount ( Facturas::CompradorCorreo ; "@" ) = 0 ]
            Show Custom Dialog [ "Email InvÃ¡lido" ; "âŒ El email ingresado no es vÃ¡lido" ]
            Exit Script [ Text Result: "Error: Email invÃ¡lido" ]
        End If
    Else
        Exit Script [ Text Result: "Cancelado por usuario" ]
    End If
End If

# ===============================
# CONFIRMACIÃ“N DE ENVÃO
# ===============================
Show Custom Dialog [ "Confirmar EnvÃ­o de Email" ; 
    "ğŸ“§ Â¿Enviar email del documento?Â¶Â¶" &
    "ğŸ“„ DATOS:Â¶" &
    "â€¢ NCF: " & Facturas::NCF & "Â¶" &
    "â€¢ Cliente: " & Facturas::CompradorNombre & "Â¶" &
    "â€¢ Email: " & Facturas::CompradorCorreo & "Â¶" &
    "â€¢ Total: RD$ " & Facturas::Total & "Â¶Â¶" &
    "El cliente recibirÃ¡ la factura electrÃ³nica por email."
    ; "Enviar Email" ; "Cancelar" 
]

If [ Get ( LastMessageChoice ) = 2 ]
    Exit Script [ Text Result: "Cancelado por usuario" ]
End If

# ===============================
# PREPARAR DATOS PARA EMAIL
# ===============================
Set Variable [ $email_json ; Value: JSONSetElement ( "{}" ;
    [ "documento" ; Facturas::NCF ; JSONString ] ;
    [ "correos[0]" ; Facturas::CompradorCorreo ; JSONString ] ;
    [ "rnc" ; "130085765" ; JSONString ]
) ]

# Para mÃºltiples emails (opcional)
# Si tienes un campo con emails separados por comas o punto y coma
If [ not IsEmpty ( Facturas::EmailsAdicionales ) ]
    Set Variable [ $emails_adicionales ; Value: Substitute ( Facturas::EmailsAdicionales ; [ "," ; "Â¶" ] ; [ ";" ; "Â¶" ] ) ]
    Set Variable [ $contador_email ; Value: 1 ]
    
    Loop
        Exit Loop If [ ValueCount ( $emails_adicionales ) < $contador_email ]
        Set Variable [ $email_adicional ; Value: GetValue ( $emails_adicionales ; $contador_email ) ]
        
        # Solo agregar si el email es vÃ¡lido
        If [ PatternCount ( $email_adicional ; "@" ) > 0 ]
            Set Variable [ $email_json ; Value: JSONSetElement ( $email_json ;
                [ "correos[" & $contador_email & "]" ; Trim ( $email_adicional ) ; JSONString ]
            ) ]
        End If
        
        Set Variable [ $contador_email ; Value: $contador_email + 1 ]
    End Loop
End If

# ===============================
# ENVIAR EMAIL
# ===============================
# Configurar cURL options (MÃ‰TODO RECOMENDADO - Headers separados)
Set Variable [ $curl_options ; Value:
    "--header \"Authorization: Bearer " & $token & "\"" & " " &
    "--header \"Content-Type: application/json\"" & " " &
    "--header \"Accept: application/json\"" & " " &
    "--data-raw " & Quote($email_json)
]

# Mostrar progreso
Show Custom Dialog [ "Enviando Email" ; "ğŸ“¤ Enviando email...Â¶Por favor espere..." ; "" ; "â³" ]

# Ejecutar envÃ­o
Insert from URL [ Select ; With dialog: Off ; Target: $resultado ; $servidor & "/comprobantes/enviar-email" ; cURL options: $curl_options ]

# ===============================
# PROCESAR RESPUESTA
# ===============================
Set Variable [ $status ; Value: JSONGetElement ( $resultado ; "status" ) ]
Set Variable [ $mensaje ; Value: JSONGetElement ( $resultado ; "message" ) ]

If [ $status = "success" ]
    # ===========================
    # EMAIL ENVIADO EXITOSAMENTE
    # ===========================
    Set Variable [ $emails_enviados ; Value: JSONGetElement ( $resultado ; "data.correos" ) ]
    Set Variable [ $documento_enviado ; Value: JSONGetElement ( $resultado ; "data.documento" ) ]
    
    # Guardar estado del email en formato JSON (MÃ‰TODO MEJORADO)
    Set Variable [ $email_resultado_json ; Value: JSONSetElement ( "{}" ;
        [ "status" ; "success" ; JSONString ] ;
        [ "fechaEnvio" ; Get ( CurrentTimeStamp ) ; JSONString ] ;
        [ "mensaje" ; $mensaje ; JSONString ] ;
        [ "documento" ; $documento_enviado ; JSONString ] ;
        [ "destinatarios" ; $emails_enviados ; JSONString ] ;
        [ "respuestaCompleta" ; $resultado ; JSONString ] ;
        [ "metodo" ; "TheFactoryHKA" ; JSONString ] ;
        [ "intentos" ; 1 ; JSONNumber ]
    ) ]
    
    # Guardar JSON completo en un solo campo
    Set Field [ Facturas::EmailResultado ; $email_resultado_json ]
    
    # Mantener campos de consulta rÃ¡pida (opcionales)
    Set Field [ Facturas::EmailEnviado ; True ]
    Set Field [ Facturas::FechaEmail ; Get ( CurrentTimeStamp ) ]
    
    # Mostrar confirmaciÃ³n
    Show Custom Dialog [ "Email Enviado Exitosamente" ; 
        "âœ… Â¡Email enviado correctamente!Â¶Â¶" &
        "ğŸ“„ Documento: " & $documento_enviado & "Â¶" &
        "ğŸ“§ Enviado a: " & $emails_enviados & "Â¶Â¶" &
        "ğŸ“‹ Detalles:Â¶" &
        $mensaje & "Â¶Â¶" &
        "ğŸ•’ Enviado: " & Get ( CurrentTimeStamp )
    ]
    
Else
    # ===========================
    # ERROR EN EL ENVÃO
    # ===========================
    Set Variable [ $error_details ; Value: JSONGetElement ( $resultado ; "details" ) ]
    
    # Guardar error en formato JSON (MÃ‰TODO MEJORADO)
    Set Variable [ $email_error_json ; Value: JSONSetElement ( "{}" ;
        [ "status" ; "error" ; JSONString ] ;
        [ "fechaError" ; Get ( CurrentTimeStamp ) ; JSONString ] ;
        [ "mensaje" ; $mensaje ; JSONString ] ;
        [ "detalles" ; $error_details ; JSONString ] ;
        [ "respuestaCompleta" ; $resultado ; JSONString ] ;
        [ "metodo" ; "TheFactoryHKA" ; JSONString ] ;
        [ "intentos" ; 1 ; JSONNumber ]
    ) ]
    
    # Guardar JSON completo en un solo campo
    Set Field [ Facturas::EmailResultado ; $email_error_json ]
    
    # Mantener campos de consulta rÃ¡pida (opcionales)
    Set Field [ Facturas::EmailEnviado ; False ]
    Set Field [ Facturas::FechaEmail ; Get ( CurrentTimeStamp ) ]
    
    # Mostrar error
    Show Custom Dialog [ "Error al Enviar Email" ; 
        "âŒ No se pudo enviar el emailÂ¶Â¶" &
        "Error: " & $mensaje & "Â¶" &
        If ( not IsEmpty ( $error_details ) ; "Detalles: " & $error_details & "Â¶" ; "" ) & "Â¶" &
        "ğŸ”§ Posibles soluciones:Â¶" &
        "â€¢ Verificar el email del compradorÂ¶" &
        "â€¢ Comprobar que la factura estÃ© aceptada en DGIIÂ¶" &
        "â€¢ Verificar conexiÃ³n a internetÂ¶" &
        "â€¢ Intentar nuevamente en unos minutos"
    ]
End If

# ===============================
# LIMPIEZA FINAL
# ===============================
# Limpiar variables sensibles
Set Variable [ $token ; Value: "" ]
Set Variable [ $curl_options ; Value: "" ]

#####################################################################
# FIN DEL SCRIPT
#####################################################################
