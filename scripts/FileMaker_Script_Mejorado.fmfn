#####################################################################
# SCRIPT FILEMAKER: Generar QR con ParÃ¡metros (MEJORADO)
# DescripciÃ³n: EnvÃ­a parÃ¡metros individuales en lugar de URL completa
# Ventaja: El servidor construye la URL segÃºn las reglas de la DGII
# VersiÃ³n: 2.0
#####################################################################

# ===============================
# CONFIGURACIÃ“N INICIAL
# ===============================
Set Variable [ $servidor ; Value: "https://tu-servidor.com" ]
Set Variable [ $token ; Value: "tu_token_bearer_aqui" ]

# ===============================
# OBTENER DATOS DE LA FACTURA
# ===============================
Set Variable [ $rnc ; Value: Facturas::EmisorRNC ]
Set Variable [ $ncf ; Value: Facturas::NCF ]
Set Variable [ $codigo ; Value: Facturas::CodigoSeguridad ]
Set Variable [ $fecha ; Value: Facturas::FechaEmision ]
Set Variable [ $monto ; Value: Facturas::Total ]

# Validar datos obligatorios
If [ IsEmpty ( $rnc ) or IsEmpty ( $ncf ) or IsEmpty ( $codigo ) or IsEmpty ( $fecha ) ]
    Show Custom Dialog [ "Datos Incompletos" ; 
        "âŒ Faltan datos obligatorios para el QR:Â¶" &
        "â€¢ RNC: " & If ( IsEmpty ( $rnc ) ; "âŒ Faltante" ; "âœ… " & $rnc ) & "Â¶" &
        "â€¢ NCF: " & If ( IsEmpty ( $ncf ) ; "âŒ Faltante" ; "âœ… " & $ncf ) & "Â¶" &
        "â€¢ CÃ³digo: " & If ( IsEmpty ( $codigo ) ; "âŒ Faltante" ; "âœ… " & $codigo ) & "Â¶" &
        "â€¢ Fecha: " & If ( IsEmpty ( $fecha ) ; "âŒ Faltante" ; "âœ… " & $fecha ) & "Â¶Â¶" &
        "ğŸ’¡ Primero debe enviar la factura electrÃ³nica"
    ]
    Exit Script [ Text Result: "Error: Datos incompletos" ]
End If

# ===============================
# PREPARAR PETICIÃ“N CON PARÃMETROS
# ===============================
Set Variable [ $headers ; Value: "Authorization: Bearer " & $token & Â¶ & 
                                "Content-Type: application/json" ]

# Usar parÃ¡metros individuales (mÃ©todo mejorado)
Set Variable [ $body ; Value: JSONSetElement ( "{}" ; 
    [ "rnc" ; $rnc ; JSONString ] ;
    [ "ncf" ; $ncf ; JSONString ] ;
    [ "codigo" ; $codigo ; JSONString ] ;
    [ "fecha" ; $fecha ; JSONString ] ;
    [ "monto" ; $monto ; JSONString ] ;
    [ "formato" ; "png" ; JSONString ] ;
    [ "tamaÃ±o" ; 200 ; JSONNumber ]
) ]

# Mostrar informaciÃ³n de la peticiÃ³n
Show Custom Dialog [ "Generando QR" ; 
    "ğŸ“± Generando cÃ³digo QR con parÃ¡metros:Â¶Â¶" &
    "ğŸ“‹ DATOS DE LA FACTURA:Â¶" &
    "â€¢ RNC: " & $rnc & "Â¶" &
    "â€¢ NCF: " & $ncf & "Â¶" &
    "â€¢ CÃ³digo: " & $codigo & "Â¶" &
    "â€¢ Fecha: " & $fecha & "Â¶" &
    "â€¢ Monto: RD$" & $monto & "Â¶Â¶" &
    "ğŸ”§ El servidor determinarÃ¡ automÃ¡ticamente:Â¶" &
    "â€¢ Endpoint correcto segÃºn el montoÂ¶" &
    "â€¢ URL final segÃºn normativas DGII" ; 
    "Generar" ; "Cancelar" 
]

If [ Get ( LastMessageChoice ) = 2 ]
    Exit Script [ Text Result: "Cancelado por usuario" ]
End If

# ===============================
# EJECUTAR PETICIÃ“N
# ===============================
# Configurar cURL options para la peticiÃ³n
Set Variable [ $curl_options ; Value: 
    "--header \"" & $headers & "\"" & 
    " --data \"" & Substitute ( $body ; "\"" ; "\\\"" ) & "\""
]

Insert from URL [ Select ; With dialog: Off ; Target: $resultado ; $servidor & "/comprobantes/generar-qr" ; cURL options: $curl_options ]

# ===============================
# PROCESAR RESPUESTA
# ===============================
Set Variable [ $status ; Value: JSONGetElement ( $resultado ; "status" ) ]

If [ $status = "success" ]
    # ===========================
    # CASO EXITOSO
    # ===========================
    Set Variable [ $qr_code ; Value: JSONGetElement ( $resultado ; "data.qrCode" ) ]
    Set Variable [ $url_generada ; Value: JSONGetElement ( $resultado ; "data.url" ) ]
    Set Variable [ $version ; Value: JSONGetElement ( $resultado ; "data.version" ) ]
    Set Variable [ $metodo_usado ; Value: JSONGetElement ( $resultado ; "data.parametrosUsados" ) ]
    Set Variable [ $cumple_dgii ; Value: JSONGetElement ( $resultado ; "data.especificaciones.cumpleNormativaDGII" ) ]
    
    # Guardar resultados
    Set Field [ Facturas::QRCode ; $qr_code ]
    Set Field [ Facturas::URLGenerada ; $url_generada ]
    Set Field [ Facturas::FechaQR ; Get ( CurrentTimeStamp ) ]
    Set Field [ Facturas::VersionQR ; $version ]
    Set Field [ Facturas::MetodoQR ; $metodo_usado ]
    
    # Determinar tipo de validaciÃ³n por el monto
    Set Variable [ $monto_numerico ; Value: GetAsNumber ( $monto ) ]
    Set Variable [ $tipo_validacion ; Value: If ( $monto_numerico >= 250000 ; "EXTENDIDA (â‰¥$250K)" ; "BÃSICA (<$250K)" ) ]
    
    # Mostrar confirmaciÃ³n detallada
    Show Custom Dialog [ "QR Generado Exitosamente" ; 
        "ğŸ‰ Â¡CÃ³digo QR generado correctamente!Â¶Â¶" &
        "ğŸ“± INFORMACIÃ“N DEL QR:Â¶" &
        "â€¢ VersiÃ³n: " & $version & " (DGII)Â¶" &
        "â€¢ MÃ©todo: " & $metodo_usado & "Â¶" &
        "â€¢ Cumple normativa: " & If ( $cumple_dgii = True ; "âœ… SÃ­" ; "âŒ No" ) & "Â¶Â¶" &
        "ğŸ” VALIDACIÃ“N DGII:Â¶" &
        "â€¢ Tipo: " & $tipo_validacion & "Â¶" &
        "â€¢ URL: " & Left ( $url_generada ; 50 ) & "..." & "Â¶Â¶" &
        "ğŸ’° MONTO ANALIZADO:Â¶" &
        "â€¢ Total: RD$" & GetAsText ( $monto_numerico ) & "Â¶" &
        "â€¢ Endpoint: " & If ( $monto_numerico >= 250000 ; "/validacion/" ; "/consulta/" ) & "Â¶Â¶" &
        "ğŸ•’ Generado: " & Get ( CurrentTimeStamp )
    ]
    
    # Marcar como procesado exitosamente
    Set Field [ Facturas::QREstado ; "Generado exitosamente" ]
    
Else
    # ===========================
    # CASO ERROR
    # ===========================
    Set Variable [ $error_msg ; Value: JSONGetElement ( $resultado ; "message" ) ]
    Set Variable [ $error_details ; Value: JSONGetElement ( $resultado ; "details" ) ]
    
    Show Custom Dialog [ "Error al generar QR" ; 
        "âŒ No se pudo generar el cÃ³digo QRÂ¶Â¶" &
        "Error: " & $error_msg & "Â¶" &
        If ( not IsEmpty ( $error_details ) ; "Detalles: " & $error_details & "Â¶" ; "" ) & "Â¶" &
        "ğŸ”§ DATOS ENVIADOS:Â¶" &
        "â€¢ RNC: " & $rnc & "Â¶" &
        "â€¢ NCF: " & $ncf & "Â¶" &
        "â€¢ CÃ³digo: " & $codigo & "Â¶" &
        "â€¢ Fecha: " & $fecha & "Â¶" &
        "â€¢ Monto: " & $monto & "Â¶Â¶" &
        "ğŸ’¡ Verifique que todos los datos sean correctos"
    ]
    
    # Guardar error para anÃ¡lisis
    Set Field [ Facturas::QREstado ; "Error: " & $error_msg ]
    Set Field [ Facturas::UltimoErrorQR ; $error_msg & " - " & Get ( CurrentTimeStamp ) ]
End If

# ===============================
# LIMPIEZA DE SEGURIDAD
# ===============================
# Limpiar variables sensibles
Set Variable [ $token ; Value: "" ]
Set Variable [ $headers ; Value: "" ]

#####################################################################
# FIN DEL SCRIPT MEJORADO
#####################################################################

/* 
ğŸ“‹ VENTAJAS DEL MÃ‰TODO MEJORADO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SIMPLICIDAD EN FILEMAKER:
â€¢ Solo envÃ­a datos bÃ¡sicos (RNC, NCF, cÃ³digo, fecha, monto)
â€¢ No necesita construir URLs complejas
â€¢ No maneja lÃ³gica de endpoints

âœ… LÃ“GICA CENTRALIZADA EN EL SERVIDOR:
â€¢ El servidor decide el endpoint segÃºn el monto
â€¢ Aplica automÃ¡ticamente las reglas de la DGII
â€¢ URL siempre correcta y actualizada

âœ… COMPATIBILIDAD AUTOMÃTICA:
â€¢ Si cambian las reglas de montos â†’ Solo actualizar servidor
â€¢ Si cambian URLs de DGII â†’ Solo actualizar servidor
â€¢ FileMaker no necesita cambios

âœ… CUMPLIMIENTO DGII:
â€¢ Monto < RD$250,000 â†’ Endpoint /consulta/
â€¢ Monto â‰¥ RD$250,000 â†’ Endpoint /validacion/ + parÃ¡metro monto
â€¢ VersiÃ³n 8 del QR segÃºn documentaciÃ³n tÃ©cnica

ğŸ“‹ DIFERENCIAS CON EL MÃ‰TODO ANTERIOR:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ANTES: FileMaker construye URL â†’ Servidor genera QR
AHORA: FileMaker envÃ­a datos â†’ Servidor construye URL â†’ Genera QR

VENTAJA: LÃ³gica de negocio centralizada en el servidor
*/